<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <title>Perfil</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background: #fafafa;
                margin: 0;
                padding: 0;
            }

            .container {
                display: flex;
                height: 100vh;
            }

            .sidebar {
                width: 200px;
                background: white;
                border-right: 1px solid #ddd;
                padding: 20px 10px;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
                display: flex;
                flex-direction: column;
            }

            .sidebar .logo {
                font-size: 22px;
                font-weight: bold;
                color: #833ab4;
                margin-bottom: 30px;
                text-align: center;
            }

            .menu button {
                background: none;
                border: none;
                text-align: left;
                font-size: 16px;
                margin-bottom: 15px;
                cursor: pointer;
                padding: 8px 10px;
                border-radius: 6px;
                width: 100%;
                transition: background 0.2s;
            }

            .menu button:hover {
                background-color: #f0f0f0;
            }

            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .topbar {
                background: white;
                padding: 10px 20px;
                border-bottom: 1px solid #ddd;
            }

            .search-bar {
                position: relative;
                max-width: 400px;
            }

            .search-bar input {
                width: 100%;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 6px;
            }

            .profile-container {
                padding: 20px;
                max-width: 900px;
                margin: 0 auto;
            }

            .profile {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-bottom: 30px;
            }

            .profile-pic {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #ccc;
            }

            .info {
                flex: 1;
            }

            .counts {
                display: flex;
                gap: 20px;
                margin: 10px 0;
            }

            .counts div {
                font-weight: bold;
            }

            .bio, #username {
                white-space: pre-wrap;
            }

            .follow-btn {
                background-color: #0095f6;
                color: white;
                padding: 6px 12px;
                border: none;
                cursor: pointer;
                border-radius: 4px;
            }

            .gallery {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
                clear: both;
            }

            .gallery img {
                width: 100%;
                aspect-ratio: 1;
                object-fit: cover;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <aside class="sidebar">
                <div class="logo">Instagram</div>
                <nav class="menu">
                    <button onclick="window.location.href = 'home.html'">üè† Inicio</button>
                    <button onclick="document.getElementById('searchInput').focus()">üîç Buscar</button>
                    <button onclick="window.location.href = 'profile.html'">üë§ Perfil</button>
                </nav>
            </aside>

            <main class="main-content">
                <header class="topbar">
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Buscar usuarios..." oninput="buscarUsuarios()" autocomplete="off">
                        <div id="searchResults"></div>
                    </div>
                </header>

                <div class="profile-container">
                    <div class="profile">
                        <img src="" alt="Foto de perfil" class="profile-pic" id="profilePicture">
                        <div class="info">
                            <h2 id="username"></h2>
                            <div class="counts">
                                <div><span id="postsCount">0</span> publicaciones</div>
                                <div><span id="followersCount">0</span> seguidores</div>
                                <div><span id="followingCount">0</span> seguidos</div>
                            </div>
                            <p class="bio" id="bio">Aqu√≠ va tu biograf√≠a.</p>
                            <button class="follow-btn" id="followBtn">Cargando...</button>
                        </div>
                    </div>

                    <div class="gallery" id="gallery"></div>
                </div>
            </main>
        </div>

        <script>
            const followBtn = document.getElementById('followBtn');
            const username = localStorage.getItem('username');
            let profileUsername = "";

            async function verificarSeguido() {
                try {
                    profileUsername = document.getElementById("username").textContent.trim();
                    const response = await fetch(`http://localhost:8091/follow/status?from=${username}&to=${profileUsername}`);
                    const data = await response.json();

                    followBtn.textContent = data.following ? "Dejar de seguir" : "Seguir";
                } catch (error) {
                    console.error("Error al verificar seguimiento:", error);
                    followBtn.textContent = "Error";
                    followBtn.disabled = true;
                }
            }

            async function toggleFollow() {
                try {
                    const action = followBtn.textContent === "Seguir" ? "follow" : "unfollow";
                    const response = await fetch(`http://localhost:8091/follow/${action}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({fromUsername: username, toUsername: profileUsername})
                    });

                    const result = await response.json();

                    if (result.success) {
                        followBtn.textContent = action === "follow" ? "Dejar de seguir" : "Seguir";
                        await actualizarContadores();
                    } else {
                        alert("Error al actualizar seguimiento: " + result.message);
                    }
                } catch (error) {
                    console.error("Error al enviar solicitud de seguimiento:", error);
                    alert("Error de red");
                }
            }

            async function actualizarContadores() {
                const perfil = await fetch(`http://localhost:8091/profile/${profileUsername}`).then(r => r.json());
                document.getElementById("followersCount").textContent = perfil.followers;
                document.getElementById("followingCount").textContent = perfil.following;
            }

            async function cargarPerfil(username) {
                const response = await fetch(`http://localhost:8091/profile/${username}`);
                const perfil = await response.json();

                profileUsername = perfil.user.username;
                document.getElementById("username").textContent = profileUsername;
                document.getElementById("bio").textContent = perfil.bio;
                document.getElementById("profilePicture").src = perfil.profilePicture ;
            }

            async function cargarGaleria(username) {
                const resUser = await fetch(`http://localhost:8091/auth/by-username/${username}`);
                const useer = await resUser.json();
                const response = await fetch(`http://localhost:8091/posts/galleryPost?userId=${useer.id}`);
                const posts = await response.json();

                const galeria = document.getElementById("gallery");
                galeria.innerHTML = "";

                posts.forEach(post => {
                    const img = document.createElement("img");
                    img.src = post.imageUrl;
                    img.alt = "Post";
                    galeria.appendChild(img);
                });
                document.getElementById("postsCount").textContent = posts.length;
            }

            followBtn.addEventListener('click', toggleFollow);

            document.addEventListener('DOMContentLoaded', async () => {
                const usuario = localStorage.getItem("profileToLoad");
                await cargarPerfil(usuario);
                await verificarSeguido();
                await actualizarContadores();
                await cargarGaleria(usuario);
            });
        </script>
    </body>
</html>
