<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Instagram - Registro e Inicio</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
                height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 0;
            }

            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                width: 350px;
            }

            .logo {
                text-align: center;
                font-size: 35px;
                font-weight: bold;
                color: #833ab4;
                margin-bottom: 20px;
            }

            .form {
                display: none;
            }

            .form.active {
                display: block;
            }

            input {
                width: 100%;
                padding: 12px;
                margin: 8px 0;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 14px;
                box-sizing: border-box;
            }

            input:focus {
                border-color: #833ab4;
                outline: none;
            }

            .btn {
                width: 100%;
                background: linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045);
                color: white;
                padding: 12px;
                border: none;
                border-radius: 5px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                margin-top: 10px;
            }

            .btn:hover {
                opacity: 0.9;
            }

            .switch-link {
                text-align: center;
                margin-top: 20px;
                color: #666;
            }

            .switch-link a {
                color: #833ab4;
                text-decoration: none;
                cursor: pointer;
            }

            .switch-link a:hover {
                text-decoration: underline;
            }

            .forgot-password {
                text-align: center;
                margin-top: 15px;
            }

            .forgot-password a {
                color: #833ab4;
                text-decoration: none;
                font-size: 12px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="logo">Instagram</div>
            <div id="mensaje" style="text-align:center; margin-top:10px;"></div>

            <!-- Formulario de Registro -->
            <div id="registerForm" class="form active">
                <form id="formRegistro">
                    <input type="email" id="email" name="email" placeholder="Email" required>
                    <input type="text" id="fullName" name="fullName" placeholder="Nombre completo" required>
                    <input type="text" id="username" name="username" placeholder="Usuario" required>
                    <input type="password" id="password" name="password" placeholder="Contraseña" required>
                    <button id="btnregistrar" type="submit" class="btn">Registrarse</button>
                </form>

                <div class="switch-link">
                    ¿Ya tienes cuenta? <a onclick="showLogin()">Inicia sesión</a>
                </div>
            </div>

            <!-- Formulario de Inicio de Sesión -->
            <div id="loginForm" class="form">
                <form id="formLogin">
                    <input type="text" id="usuario" placeholder="Username" required>
                    <input type="password" id="password1" placeholder="Contraseña" required>
                    <button type="submit" class="btn">Iniciar sesión</button>
                </form>


                <div class="forgot-password">
                    <a href="#">¿Olvidaste tu contraseña?</a>
                </div>

                <div class="switch-link">
                    ¿No tienes cuenta? <a onclick="showRegister()">Regístrate</a>
                </div>
            </div>
        </div>

        <script>
            function showLogin() {
                document.getElementById('registerForm').classList.remove('active');
                document.getElementById('loginForm').classList.add('active');
            }

            function showRegister() {
                document.getElementById('loginForm').classList.remove('active');
                document.getElementById('registerForm').classList.add('active');
            }

            // Evento de registro
            document.getElementById("formRegistro").addEventListener("submit", async (evento) => {
                
                evento.preventDefault();
                let mensaje = document.getElementById("mensaje");
                mensaje.textContent = ""; // limpia mensajes anteriores
                mensaje.style.color = "orange";
                    mensaje.textContent = "Espera un momento ... :)";

                let email = document.getElementById("email").value;
                let fullName = document.getElementById("fullName").value;
                let username = document.getElementById("username").value;
                let password = document.getElementById("password").value;


                // Validaciones
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/;
                if (!emailRegex.test(email)) {
                    mensaje.style.color = "red";
                    mensaje.textContent = "El correo electrónico no es válido. Debe contener '@' y un dominio.";
                    return;
                }

                if (!passwordRegex.test(password)) {
                    mensaje.style.color = "red";
                    mensaje.textContent = "La contraseña debe tener mínimo 8 caracteres, una mayúscula, una minúscula, un número y un carácter especial.";
                    return;
                }

                let campos = {email, fullName, username, password};
                const respuesta = await fetch("http://localhost:8091/auth/register", {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(campos)
                });
                if (respuesta.ok) {
                    mensaje.style.color = "green";
                    mensaje.textContent = "Usuario registrado con éxito";
                    showLogin();
                } else {
                    mensaje.style.color = "red";
                    mensaje.textContent = "Hubo un error al registrar";
                }
            });

            document.getElementById('formLogin').addEventListener('submit', async function (e) {
                e.preventDefault(); // Previene el envío normal del formulario

                const usernameOrEmail = document.getElementById('usuario').value;
                const password = document.getElementById('password1').value;
                const mensajeDiv = document.getElementById('mensaje');



                try {
                    const response = await fetch('http://localhost:8091/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            usernameOrEmail: usernameOrEmail,
                            password: password
                        })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        mensajeDiv.style.color = 'green';
                        mensajeDiv.innerText = result.message;

                        localStorage.setItem("userId", result.user.id);
                        localStorage.setItem("username", usernameOrEmail);
                        localStorage.setItem("fullName", result.user.fullName);
                        localStorage.setItem("email", result.user.email);
                        
                        localStorage.setItem("profileToLoad","hailen2");
                        //localStorage.setItem("username", usuarioLo
                        //gueado.username);

                        // Puedes guardar datos del usuario si quieres:
                        // localStorage.setItem("user", JSON.stringify(result.user));

                        // O redirigir al feed:
                        // POR EL MOMENTO REDIRECCIONA AL PERFIL PROPIO O A UNO AJENO
                        window.location.href = "http://localhost:8383/parcial3pafrontend/home.html";
                    } else {
                        mensajeDiv.style.color = 'red';
                        mensajeDiv.innerText = result.message || "Credenciales inválidas";
                    }

                } catch (error) {
                    console.error("Error al hacer login:", error);
                    mensajeDiv.style.color = 'red';
                    mensajeDiv.innerText = "Error al conectar con el servidor";
                }
            });



        </script>
    </body>
</html>
